/*
 * game_p4.c
 *
 *  Created on: 30 mars 2020
 *      Author: marc
 */
#include <stdio.h>
#include <stdint.h>
#include "debug.h"
#include "game_p4.h"

static int8_t matrix[NB_OF_COLUMN][NB_OF_LINE];
/* token_top_selector = position du jeton dans ligne de sélection (de 0 à NB_OF_COLUMN -1)*/
static int8_t token_top_selector;
static int8_t active_player;

/* vide la matrice
 * fixe le active_player
 * initialise les couleurs associées à chaque joueur
 * */
void gp4_init(void) {
	for (int8_t row = 0; row < NB_OF_LINE; row++) {
		for (int8_t col = 0; col < NB_OF_COLUMN; col++) {
			matrix[col][row] = EMPTY_SPACE;
		}
	}
	active_player = PLAYER_1;
	token_top_selector = 0;
}

void gp4_show_board(void) {
	printf("\ntop line\t");
	for (int8_t col = 0; col < NB_OF_COLUMN; col++) {
		if (col == token_top_selector) {
			printf("%d ", active_player);
		} else {
			printf("%d ", EMPTY_SPACE);
		}
	}

	for (int8_t row = 0; row < NB_OF_LINE; row++) {
		printf("\nline %d  \t", row);
		for (int8_t col = 0; col < NB_OF_COLUMN; col++) {
			printf("%d ", matrix[col][row]);
		}
	}
	printf("\n");
}

void gp4_next_player(void) {
	if (active_player == PLAYER_1) {
		active_player = PLAYER_2;
		token_top_selector = 0;
	} else {
		active_player = PLAYER_1;
		token_top_selector = 0;
	}
}

void gp4_move_left(void) {
	token_top_selector -= 1;
	while ((matrix[token_top_selector][0] != 0) && token_top_selector > 0){
		token_top_selector -= 1;
		if (token_top_selector < 0) {
			token_top_selector = NB_OF_COLUMN - 1;
		}
	}
}

void gp4_move_right(void) {
	token_top_selector += 1;
	if (token_top_selector > (NB_OF_COLUMN - 1)) {
		token_top_selector = 0;
	}
}

void gp4_play_token(void) {
	for (int8_t row = 0; row < NB_OF_LINE; row++) {
		if (matrix[token_top_selector][row + 1] != 0) {
			matrix[token_top_selector][row] = active_player;
		}
	}
	if (matrix[token_top_selector][NB_OF_LINE - 1] == 0) {
		matrix[token_top_selector][NB_OF_LINE - 1] = active_player;
	}

}

void gp4_test_move_all(void) {
	debug_printf(0, "Entrée dans la fonction de test de mouvements\n");
	debug_printf(0, "initialisation matrice + mouvement joueur à gauche\n");
	gp4_init();
	gp4_show_board();
	gp4_move_left();
	gp4_show_board();
	debug_printf(0, "changement de joueur\n");
	gp4_next_player();
	gp4_show_board();
	debug_printf(0, "déplacement jeton extremité droite\n");
	token_top_selector = NB_OF_COLUMN - 1;
	gp4_show_board();
	debug_printf(0, "mouvement joueur à droite\n");
	gp4_move_right();
	gp4_show_board();

}

void gp4_test_play_token(void) {
	debug_printf(0,
			"Entrée dans la fonction de test de validation de mouvement\n");
	debug_printf(0,
			"initialisation matrice + 3 coups sans mouvement du joueur 1\n");
	gp4_init();
	gp4_show_board();
	gp4_play_token();
	gp4_show_board();
	gp4_play_token();
	gp4_show_board();
	gp4_play_token();
	gp4_show_board();
}
